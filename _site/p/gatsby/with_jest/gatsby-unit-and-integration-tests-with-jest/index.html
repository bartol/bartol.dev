<p><a href="https://jestjs.io/">Jest</a> is JavaScript testing framework used for testing plenty of technologies, including Gatsby (React). To get started all you need is to install <a href="https://github.com/testing-library/react-testing-library">react testing library</a> (which will add React related functionality like rendering components) and Jest itself.</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">yarn</span> <span class="token function">add</span> -D jest @testing-library/react</span></code></pre>
<p>In true <em>zero config</em> we will create <code>__tests__</code> directory next to component we want to test and file in it with same name as component that will contain testing code.</p>
<pre class="language-jsx"><code class="language-jsx"><span class="highlight-line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span></span><br><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing-library/react'</span></span><br><span class="highlight-line"><span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">'../Component'</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'works'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token regex">/First Name/i</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>After that we need to add new script in <code>package.json</code>.</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line">...</span><br><span class="highlight-line"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"jest"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line">...</span></code></pre>
<p>Great! Now run it! And it fails...</p>
<h2>I knew this won't be <em>that</em> easy</h2>
<p>You have run into errors because Node doesn't support import statements, yet. This wouldn't be an issue in <em>normal</em> React app where Babel is configured manually. Jest would just use already created Babel config. But with Gatsby story is a bit different. Gatsby hides Babel config from us and you guessed it, Jest! So we need to configure it ourselves.</p>
<p>Let's get back to command line for a few more packages.</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">yarn</span> <span class="token function">add</span> -D babel-jest babel-preset-gatsby identity-obj-proxy</span></code></pre>
<p>Then create <code>jest.config.js</code> in project root.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  transform<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string">'^.+\\.jsx?$'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;rootDir>/tests/jest-preprocess.js</span><span class="token template-punctuation string">`</span></span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  moduleNameMapper<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string">'.+\\.(css|styl|less|sass|scss)$'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">identity-obj-proxy</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token string">'.+\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;rootDir>/tests/file-mock.js</span><span class="token template-punctuation string">`</span></span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  testPathIgnorePatterns<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.cache</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  transformIgnorePatterns<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/(?!(gatsby)/)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  globals<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    __PATH_PREFIX__<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  testURL<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost</span><span class="token template-punctuation string">`</span></span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>After that create <code>tests</code> directory with <code>jest-preprocess.js</code> and <code>file-mock.js</code> files.</p>
<p>In <code>jest-preprocess.js</code> add following code snippet.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> babelOptions <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'babel-preset-gatsby'</span><span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-jest'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTransformer</span><span class="token punctuation">(</span>babelOptions<span class="token punctuation">)</span></span></code></pre>
<p>And in <code>file-mock.js</code> add this line.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">'test-file-stub'</span></span></code></pre>
<p>Finally, re-run tests and everything should work perfectly!</p>
