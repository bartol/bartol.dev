<p>I was recently in <em>search</em> for this blog's search. Tried <a href="https://www.algolia.com/">Algolia</a>, it was great, but it didn't fit my needs well. I have even made article about it, <a href="https://bartol.dev/rethinking-fuzzy-search/">Rethinking fuzzy search</a>. If you want to know <strong>why</strong>, read that article, but if you want to see <strong>how</strong>, continue reading this.</p>
<h3>Prerequisites</h3>
<ul>
<li>Existing React app and way to get data you want to search (example: array of articles)</li>
</ul>
<h3>Goals</h3>
<ul>
<li>Build client-only fuzzy search</li>
</ul>
<p>First thing you have to do is, as expected, install <a href="https://fusejs.io/">fuse.js</a>.</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">yarn</span> <span class="token function">add</span> fuse.js</span></code></pre>
<p>While yarn is doing its work, you can import libraries to file. Import from Gatsby is optional because that is way I get my search data and will probably vary. Just make sure your data is array!</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">import</span> Fuse <span class="token keyword">from</span> <span class="token string">'fuse.js'</span></span><br><span class="highlight-line"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span></span><br><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> useStaticQuery<span class="token punctuation">,</span> graphql <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'gatsby'</span></span></code></pre>
<p>Next thing is to get data for search. Like I already said, process of getting this data will vary from app to app. As example, I am using GraphQL and Gatsby static query to get array of articles.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">useStaticQuery</span><span class="token punctuation">(</span>graphql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br><span class="highlight-line">    {</span><br><span class="highlight-line">      allMarkdownRemark {</span><br><span class="highlight-line">        nodes {</span><br><span class="highlight-line">          frontmatter {</span><br><span class="highlight-line">            title</span><br><span class="highlight-line">            tags</span><br><span class="highlight-line">            date(formatString: "MMMM Do, YYYY")</span><br><span class="highlight-line">          }</span><br><span class="highlight-line">          fields {</span><br><span class="highlight-line">            slug</span><br><span class="highlight-line">            timestamp</span><br><span class="highlight-line">            views</span><br><span class="highlight-line">          }</span><br><span class="highlight-line">          id</span><br><span class="highlight-line">          excerpt(pruneLength: 1000000)</span><br><span class="highlight-line">        }</span><br><span class="highlight-line">      }</span><br><span class="highlight-line">    }</span><br>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">const</span> allResults <span class="token operator">=</span> data<span class="token punctuation">.</span>allMarkdownRemark<span class="token punctuation">.</span>nodes</span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// allResults looks similar to this:</span></span><br><span class="highlight-line">  <span class="token comment">//</span></span><br><span class="highlight-line">  <span class="token comment">// [</span></span><br><span class="highlight-line">  <span class="token comment">//   {</span></span><br><span class="highlight-line">  <span class="token comment">//     frontmatter: { ... }</span></span><br><span class="highlight-line">  <span class="token comment">//     fields: { ... }</span></span><br><span class="highlight-line">  <span class="token comment">//     id</span></span><br><span class="highlight-line">  <span class="token comment">//     excerpt</span></span><br><span class="highlight-line">  <span class="token comment">//   },</span></span><br><span class="highlight-line">  <span class="token comment">//   ....</span></span><br><span class="highlight-line">  <span class="token comment">// ]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>After getting data in correct format you'll need to initialize state for results and search input.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">,</span> setResults<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>allResults<span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token keyword">const</span> <span class="token punctuation">[</span>query<span class="token punctuation">,</span> setQuery<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span></span></code></pre>
<p>You'll need to define fuse and it's options. These are options that work for me. Feel free to play around with search later and tweak to your liking.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  shouldSort<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  includeScore<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  includeMatches<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  threshold<span class="token punctuation">:</span> <span class="token number">0.33</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  location<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  distance<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  maxPatternLength<span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  minMatchCharLength<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  keys<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'frontmatter.title'</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'frontmatter.tags'</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token number">0.75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'frontmatter.excerpt'</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token number">0.5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> fuse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fuse</span><span class="token punctuation">(</span>allResults<span class="token punctuation">,</span> options<span class="token punctuation">)</span></span></code></pre>
<p>Last thing you have to do for search to work is to actually run it on every change of query. Also, if user empties input field set <em>fallback</em> to all results.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function">setResults</span><span class="token punctuation">(</span>query <span class="token operator">?</span> fuse<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token punctuation">:</span> allResults<span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span></span></code></pre>
<p>That is it. Your search is working, when you change query, results will be filtered. But you'll need to build some UI to actually see the magic. Let's start with input. It just binds its value to query state.</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><br><span class="highlight-line">  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>search<span class="token punctuation">'</span></span></span><br><span class="highlight-line">  <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span></span><br><span class="highlight-line">  <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">event</span> <span class="token operator">=></span> <span class="token function">setQuery</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span></span><br><span class="token punctuation">/></span></span></code></pre>
<p>And to see results you will map over result array from state. Notice line 4 in this snippet. It is important because fuse.js returns original data in item property.</p>
<!-- prettier-ignore -->
<pre class="language-jsx"><code class="language-jsx"><span class="highlight-line"><span class="token punctuation">{</span>results<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text"><br>    </span><span class="token punctuation">{</span>results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">article</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br><span class="highlight-line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> frontmatter <span class="token punctuation">}</span> <span class="token operator">=</span> article<span class="token punctuation">.</span>item <span class="token operator">||</span> article <span class="token comment">// &lt;= this is important</span></span><br><span class="highlight-line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> date <span class="token punctuation">}</span> <span class="token operator">=</span> frontmatter</span><br><span class="highlight-line">      <span class="token keyword">return</span> <span class="token punctuation">(</span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br><span class="highlight-line">          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text"></span><br><span class="highlight-line">          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>date<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text"></span><br>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><br><span class="highlight-line">      <span class="token punctuation">)</span></span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"><br>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">}</span></span></code></pre>
<p>While you are at it, you can also handle situation when search has no results.</p>
<!-- prettier-ignore -->
<pre class="language-jsx"><code class="language-jsx"><span class="highlight-line"><span class="token punctuation">{</span><span class="token operator">!</span>results<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> query <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">No results</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span></code></pre>
<p>And that is now it. Everything should be working great. Don't forget to play with search and adjust search options!</p>
<p>Whole component for reference can be found in this <a href="https://gist.github.com/bartol/bdf23c6f32f44e40a33e7f289e9daad2">gist</a>.</p>
